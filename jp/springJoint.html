<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
 <meta name="keywords" content="OpenHRP,OpenHRP3,ロボット,robot,分散コンポーネント型ロボットシミュレータ,Distributed component type robot simulator,corba"> 
 <meta name="description" content="OpenHRP official site"> 

 <title>関節のバネダンパモデル化の方法</title>

 <meta http-equiv="content-type" content="text/html; charset=UTF-8">
 <meta http-equiv="content-style-type" content="text/css">
 <meta http-equiv="content-script-type" content="text/javascript">

 <link rel="stylesheet" href="../style/default.css" type="text/css" media="screen" charset="UTF-8" />
 <link rel="stylesheet" href="../style/greybox/greybox.css" type="text/css" media="all" charset="UTF-8" />
 <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

</head>

<body>

<div id="header">

 <a href="../index.html">
  <img id="logo" src="../image/openhrp3banner.jpg" width="200" height="94" alt="OpenHRP3" title="OpenHRP3" />
 </a>

   <h1 class="title">関節のバネダンパモデル化の方法</h1><br>
   <div align="right"><a href="../en/index.html">English &gt;&gt;</a></div>
</div>


<div id="navigator"> 
<hr class="full_hr" /></div>


<div id="contents">
<table class="contents" width="100%" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td class="ltable" valign="top"><div id="menubar">

   <h2 id="h2_content_1">基本情報</h2>
    <ul class="menu">
     <li><a href="../jp/index.html">ホーム（お知らせ）</a></li>
     <li><a href="../jp/about.html">OpenHRP3とは</a></li>
     <li><a href="../jp/download.html">ダウンロード</a></li>
    </ul>

   <h2 id="h2_content_2">ドキュメント</h2>
    <ul class="menu">
     <li><a href="../jp/install.html">インストール<br>(Ver.3.1.4)</a></li>
     <li><a href="../jp/install_3_0.html">インストール<br>(Ver.3.0.8)</a></li>
     <li><a href="../jp/users_manual.html">ユーザーズマニュアル<br>(Ver.3.1.4)</a></li>
     <li><a href="../jp/users_manual_3_0.html">ユーザーズマニュアル<br>(Ver.3.0.8)</a></li>
     <li><a href="../jp/programming.html">プログラミングマニュアル</a></li>
     <li><a href="../jp/UT_DynamicsSimulator.pdf">力学計算アルゴリズム</a></li>
     <li><a href="../jp/reference_manuals.html">リファレンスマニュアル</a></li>
    </ul>

   <h2 id="h2_content_3">補足情報</h2>
    <ul class="menu">
     <li><a href="../jp/samples.html">サンプル動画</a></li>
     <li><a href="../jp/tips.html">Tips</a></li>
     <li><a href="../jp/troubleshooting.html">Troubleshooting<br>(Ver.3.1)</a></li>
     <li><a href="../jp/troubleshooting_3_0.html">Troubleshooting<br>(Ver.3.0)</a></li>
     <li>既知の不具合</li>
     <!--<li><a href="../jp/known_bugs.html">既知の不具合</a></li>-->
     <li><a href="../jp/papers.html">発表論文</a></li>
    </ul>

   <h2 id="h2_content_4">サポート</h2>
    <ul class="menu">
     <li><a href="../jp/forum.html">質問用掲示板</a></li>
     <li>講習会情報</li>
     <!--<li><a href="../jp/workshop.html">講習会情報</a></li>-->
    </ul>

    
   <h2 id="h2_content_5">リンク</h2>
    <ul class="menu">
     <li><a href="https://openrtp.jp/excade/wiki/excade">動作パターン設計ツール</a></li>
     <li><a href="http://www.openrtm.org/openrtm/" target="_blank">OpenRTM-aist</a></li>
     <li><a href="http://unit.aist.go.jp/is/humanoid/hrp-4c/hrp-4c.html" target="_blank">HRP-4Cモデル</a></li>
     <li><a href="http://code.google.com/p/rtm-ros-robotics/" target="_blank">RTM-ROS 相互運用プロジェクト</a></li>
     <!--<li><a href="http://www.is.aist.go.jp/humanoid/openhrp/Japanese/" target="_blank">旧バージョン(OpenHRP2)</a></li>-->
    </ul>
    
    <h2 id="h2_content_6">HP ログ</h2></li>
    <ul class="menu">
     <li><a href="../jp/old_versions.html">OpenHRP3 他バージョン</a></li>
    </ul>


</div></td>

  <td class="ctable" valign="top">

   <div id="body">


<h2>概要</h2>

<p>
OpenHRPには、モデル固有のプログラムを、動的に動力学計算ライブラリに組み込む仕組みとして、"BodyCustomizer"というプラグインを用意しています。<br>
このプラグインを使用すると、あるモデルに対して解析的な逆運動学や関節のバネダンパモデルを組み込むことができます。<br>
ここでは、サンプルプロジェクトspringJoint.xmlを用いて、関節をバネダンパモデル化する手順を説明します。<br>
</p>

<h2>モデルの作成</h2>
<p>
サンプルでは、2つの箱（リンク）の間に、バネダンパモデルの関節が定義されている、springJointという名前を付けたモデルを使用します。<br>
ファイルは、(openHRP)/sample/model/springJoint.wrlです。<br>
通常の関節と同様にバネダンパ化する関節を定義し、バネダンパの変位の方向を設定します。制御対象ではない関節なので、JointIDは設定しなくてもかまいません。<br>
この関節には、SPRING_JOINTという名前を付けています。<br>
</p>
<div>
<code>
<pre>
DEF springJoint Humanoid {
  version "1.1"
  humanoidBody [
    DEF ROOT Joint {
        :
        :
        DEF SPRING_JOINT Joint {
            translation     0 0 0.05
            jointType "slide"
	        jointAxis 0 0 1
                :
                :
</pre>
</code>
</div>

<h2>プラグインの作成</h2>
<h3>ソースコード</h3>
<p>
次に、作成したモデル用のプラグインを作成します。サンプルのソースコードは（OpenHRP)/sample/example/customizer/customizer.cppです。<br>
</p>
<div>
<code>
<pre>
static const char** getTargetModelNames()
{
    static const char* names[] = { 
        "springJoint",
        0 };
	
    return names;
}
</pre>
</code>
</div>
<p>
このプラグインが、どのモデルに適用されるかを動力学ライブラリに知らせる関数です。モデル定義のファイル中に設定されている名前を羅列した配列を返します。<br>
GrxUIで読み込んだモデルにつける名前ではありませんので注意してください。<br>
（OpenHRPでは、同じロボットが複数台ある場合に、個々のロボットを識別するためにファイル中の名前とは別のモデル名を付けられるようになっています。<br>
同じロボットの個々に、プラグインを指定したい場合は、モデルファイルから別に定義する必要があります。）<br>
配列の最後には'0'を入れます。<br>
</p>
<div>
<code>
<pre>
static BodyCustomizerHandle create(BodyHandle bodyHandle, const char* modelName)
{
    Customizer* customizer = 0;
	
    string name(modelName);
    if(name == "springJoint"){
        customizer = new Customizer;
        customizer->bodyHandle = bodyHandle;
        customizer->springT = 1.0e3;    
        customizer->dampingT = 1.0e1;
        int jointIndex = bodyInterface->getLinkIndexFromName(bodyHandle, "SPRING_JOINT");
        if(jointIndex >=0 ){
            JointValSet& jointValSet = customizer->jointValSet;
            jointValSet.valuePtr = bodyInterface->getJointValuePtr(bodyHandle, jointIndex);
            jointValSet.velocityPtr = bodyInterface->getJointVelocityPtr(bodyHandle, jointIndex);
            jointValSet.torqueForcePtr = bodyInterface->getJointForcePtr(bodyHandle, jointIndex);
        }
    }

    return static_cast&lt;BodyCustomizerHandle&gt;(customizer);
}

</pre>
</code>
</div>
<p>
createがプラグインの最初に呼び出される関数です。変数の初期化などを行います。<br>
ここでは、プラグインから、動力学ライブラリの変数にアクセスする方法も記述されています。<br>
動力学ライブラリからプラグインに対して提供される関数は以下の通りです。
<table border="1" align="center">
<tr><td>getLinkIndexFromName</td><td>関節の名前から、ライブラリ中での識別番号に変換します。</td></tr>
<tr><td>getLinkName</td><td>識別番号から、関節の名前に変換します。</td></tr>
<tr><td>getJointValuePtr</td><td>識別番号の示す関節の位置を表す変数のポインタを返します。</td></tr>
<tr><td>getJointVelocityPtr</td><td>識別番号の示す関節の速度を表す変数のポインタを返します。</td></tr>
<tr><td>getJointForcePtr</td><td>識別番号の示す関節のトルクを表す変数のポインタを返します。</td></tr>
</table>
</p>
<div>
<code>
<pre>
static void destroy(BodyCustomizerHandle customizerHandle)
{
    Customizer* customizer = static_cast&lt;Customizer*&gt;(customizerHandle);
    if(customizer){
        delete customizer;
    }
}
</pre>
</code>
</div>
<p>
 destroyは、プラグインが破棄されるときに呼び出される関数です。後処理を行います。
</p>
<div>
<code>
<pre>
extern "C" DLL_EXPORT
NS_HRPMODEL::BodyCustomizerInterface* getHrpBodyCustomizerInterface(NS_HRPMODEL::BodyInterface* bodyInterface_)
{
    bodyInterface = bodyInterface_;

    bodyCustomizerInterface.version = NS_HRPMODEL::BODY_CUSTOMIZER_INTERFACE_VERSION;
    bodyCustomizerInterface.getTargetModelNames = getTargetModelNames;
    bodyCustomizerInterface.create = create;
    bodyCustomizerInterface.destroy = destroy;
    bodyCustomizerInterface.initializeAnalyticIk = 0;
    bodyCustomizerInterface.calcAnalyticIk = 0;
    bodyCustomizerInterface.setVirtualJointForces = setVirtualJointForces;

    return &bodyCustomizerInterface;
}
</pre>
</code>
</div>
<p>
このプラグインが提供する関数を動力学ライブラリに知らせるための関数です。実装している関数名を記述した構造体を返します。<br>
実装していない関数には、'0'を代入してください。<br>
<br>
以上４つの関数は、プラグインのなかで必ず実装する必要があります。
<div>
<code>
<pre>
static void setVirtualJointForces(BodyCustomizerHandle customizerHandle)
{
    Customizer* customizer = static_cast&lt;Customizer*&gt;(customizerHandle);
    JointValSet& trans = customizer->jointValSet;
    *(trans.torqueForcePtr) = - customizer->springT * (*trans.valuePtr) - customizer->dampingT * (*trans.velocityPtr);
}
</pre>
</code>
</div>
<p>
動力学ライブラリの積分ループで1ステップ毎に呼び出されます。ここに、バネダンパ化のコードを実装します。<br>
</p>
<h3>インストール</h3>
<p>
作成したソースコードをコンパイルして、ライブラリを作成します。この時、ライブラリ名は、必ず***Customizer.so(dll)のようにします。<br>
これを、(OpenHRP3インストール先）/share/OpenHRP-3.1/customizerの下にコピーします。<br>
（サンプルは、OpenHRPのインストール時にインストールされます。）<br>
動力学ライブラリは、このディレクトにある***Customizer.so(dll)という名前のプラグインをすべてロードします。<br>


<h2>サンプルの実行</h2>
GrxUIを起動し、プロジェクトspringJoint.xmlをloadします。<br>
シミュレーションを開始すると、床の上に落ちた後、上の箱が上下に震動します。<br>

<h2>デフォルトのゴムブッシュ用customizer</h2>
上記のゴムブッシュをシミュレートするcustomizerサンプルはspringJoint.xml用の記述例でした。
任意の個数・任意の自由度のゴムブッシュをシミュレートするための
"BushCustomizer"がデフォルトで読み込まれます。<br>
"BushCustomizer"を使うには、
<ol>
  <li> 使用しているロボットモデルのVRMLファイルにブッシュ用関節を定義し、別ファイルとして保存する
  <li> BushCustomizer用パラメータファイルを記述する (confファイル)
  <li> BUSH_CUSTOMIZER_CONFIG_PATH環境変数で上記パラメータファイルのパスを指定する
  <li> プロジェクトファイルのロボットモデルパスに、ゴムブッシュ有りVRMLを記述する（基本的にはそれ以外のロボットモデルパスはゴムブッシュなしのもので構いません）。
</ol>
とすることで利用できます。<br>

2のパラメータファイルは以下のような情報を与えてください。
<table border="1" align="center">
<tr><td>robot_model_name</td><td>ロボットモデル名</td></tr>
<tr><td>bush_config</td><td>N個のブッシュのパラメータを空白で区切り記述します。各パラメータは、カンマで"ブッシュ関節名,バネ係数,ダンパ係数"を指定します。slide関節、rotate関節でそれぞれバネ係数は[N/m],[Nm/rad]、ダンパ係数は[N/(m/s)],[Nm/(rad/s)]です。</td></tr>
</table>

サンプルとなる記述例は
<ul>
  <li> 1のVRMLファイルはsample/model/sample1_bush.wrl (sample1.wrlをゴムブッシュ追加したもの)
  <li> 2のパラメータファイルはsample/example/customizer/sample1_bush_customizer_param.conf
</ul>
にあり、２足ロボットの両足首にそれぞれZ軸直動ブッシュ、X・Y軸回転ブッシュが定義されています。
<code>
<pre>
robot_model_name: SampleRobot
bush_config: RLEG_BUSH_Z,5.0e5,1.0e3 RLEG_BUSH_ROLL,1.0e3,2.5e1 RLEG_BUSH_PITCH,1.0e3,2.5e1 LLEG_BUSH_Z,5.0e5,1.0e3 LLEG_BUSH_ROLL,1.0e3,2.5e1 LLEG_BUSH_PITCH,1.0e3,2.5e1
</pre>
</code>

    






</div>
  </td>
 </tr>
</table>
</div>



<hr class="full_hr" />



<div id="footer">
<table id="footertable" border="0" cellspacing="0" cellpadding="0">
<tr>
 <td id="footerctable"><div id="sigunature">
  Administrator: OpenHRP Team, Humanoid Resarch Group, Intelligent Systems Research Institute, AIST
 </div></td>
</tr>
</table>
</div>

</body>
</html>
