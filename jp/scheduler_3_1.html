<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
 <meta name="keywords" content="OpenHRP,OpenHRP3,ロボット,robot,分散コンポーネント型ロボットシミュレータ,Distributed component type robot simulator,corba"> 
 <meta name="description" content="OpenHRP official site"> 

 <title>スケジューラ作成法(Ver.3.1)</title>

 <meta http-equiv="content-type" content="text/html; charset=UTF-8">
 <meta http-equiv="content-style-type" content="text/css">
 <meta http-equiv="content-script-type" content="text/javascript">

 <link rel="stylesheet" href="../style/default.css" type="text/css" media="screen" charset="UTF-8" />
 <link rel="stylesheet" href="../style/greybox/greybox.css" type="text/css" media="all" charset="UTF-8" />
 <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

</head>

<body>

<div id="header">

 <a href="../index.html">
  <img id="logo" src="../image/openhrp3banner.jpg" width="200" height="94" alt="OpenHRP3" title="OpenHRP3" />
 </a>

   <h1 class="title">スケジューラ作成法(Ver.3.1)</h1><br>
   <div align="right"><a href="../en/index.html">English &gt;&gt;</a></div>
</div>


<div id="navigator"> 
<hr class="full_hr" /></div>


<div id="contents">
<table class="contents" width="100%" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td class="ltable" valign="top"><div id="menubar">

   <h2 id="h2_content_1">基本情報</h2>
    <ul class="menu">
     <li><a href="../jp/index.html">ホーム（お知らせ）</a></li>
     <li><a href="../jp/about.html">OpenHRP3とは</a></li>
     <li><a href="../jp/download.html">ダウンロード</a></li>
    </ul>

   <h2 id="h2_content_2">ドキュメント</h2>
    <ul class="menu">
     <li><a href="../jp/install.html">インストール<br>(Ver.3.1.4)</a></li>
     <li><a href="../jp/install_3_0.html">インストール<br>(Ver.3.0.8)</a></li>
     <li><a href="../jp/users_manual.html">ユーザーズマニュアル<br>(Ver.3.1.4)</a></li>
     <li><a href="../jp/users_manual_3_0.html">ユーザーズマニュアル<br>(Ver.3.0.8)</a></li>
     <li><a href="../jp/programming.html">プログラミングマニュアル</a></li>
     <li><a href="../jp/UT_DynamicsSimulator.pdf">力学計算アルゴリズム</a></li>
     <li><a href="../jp/reference_manuals.html">リファレンスマニュアル</a></li>
    </ul>

   <h2 id="h2_content_3">補足情報</h2>
    <ul class="menu">
     <li><a href="../jp/samples.html">サンプル動画</a></li>
     <li><a href="../jp/tips.html">Tips</a></li>
     <li><a href="../jp/troubleshooting.html">Troubleshooting<br>(Ver.3.1)</a></li>
     <li><a href="../jp/troubleshooting_3_0.html">Troubleshooting<br>(Ver.3.0)</a></li>
     <li>既知の不具合</li>
     <!--<li><a href="../jp/known_bugs.html">既知の不具合</a></li>-->
     <li><a href="../jp/papers.html">発表論文</a></li>
    </ul>

   <h2 id="h2_content_4">サポート</h2>
    <ul class="menu">
     <li><a href="../jp/forum.html">質問用掲示板</a></li>
     <li>講習会情報</li>
     <!--<li><a href="../jp/workshop.html">講習会情報</a></li>-->
    </ul>

    
   <h2 id="h2_content_5">リンク</h2>
    <ul class="menu">
     <li><a href="http://www.openrtm.org/openrtm/" target="_blank">OpenRTM-aist</a></li>
     <li><a href="http://www.choreonoid.org">Choreonoid</a></li>
     <li><a href="https://github.com/fkanehiro/hrpsys-base">hrpsys-base</a></li>
     <li><a href="http://unit.aist.go.jp/is/humanoid/hrp-4c/hrp-4c.html" target="_blank">HRP-4Cモデル</a></li>
     <li><a href="http://code.google.com/p/rtm-ros-robotics/" target="_blank">RTM-ROS 相互運用プロジェクト</a></li>
     <!--<li><a href="http://www.is.aist.go.jp/humanoid/openhrp/Japanese/" target="_blank">旧バージョン(OpenHRP2)</a></li>-->
    </ul>
    
    <h2 id="h2_content_6">HP ログ</h2></li>
    <ul class="menu">
     <li><a href="../jp/old_versions.html">OpenHRP3 他バージョン</a></li>
    </ul>


</div></td>

  <td class="ctable" valign="top">

   <div id="body">


<h2> 概要 </h2>
<p>
ここでは、通常GrxUIの操作で行っているシミュレーションを、C++によるプログラムで行う方法を、サンプルを用いて説明します。　<br/>
サンプルプログラムは、OpenHRP/sample/project/samplePD.xml プロジェクトを用いたシミュレーションと同じ動作をします。
</p>
<p>
流れは以下のとおりです。
</p>
<ol>
<li>モデルを読み込む</li>
<li>CORBA初期化</li>
<li>NamingServiceを取得する</li>
<li>OnlineViewerを取得し、モデルを読み込む</li>
<li>DynamicsServerを取得し、初期設定を行う</li>
<li>Controllerを取得し、初期設定を行う</li>
<li>シミュレーションのループ</li>
</ol>

<h3> モデルの読み込み </h3>
<p>
まず、ModelLoaderを用いてモデルファイルを読み込みます。
Model[0],model[1]には、床とロボットのモデルファイルへのパスを指定します。
</p>
<pre>
BodyInfo_var floor = loadBodyInfo(Model[0].c_str(), argc, argv);
BodyInfo_var body = loadBodyInfo(Model[1].c_str(), argc, argv);
</pre>

<a name="corbainit"></a>
<h3> CORBA初期化 </h3>
<p>
次にCORBA ORBの初期化とNamingServiceの参照取得を行います。
</p>
<pre>
CORBA::ORB_var orb;
orb = CORBA::ORB_init(argc, argv);

CORBA::Object_var poaObj = orb -> resolve_initial_references("RootPOA");
PortableServer::POA_var rootPOA = PortableServer::POA::_narrow(poaObj);

PortableServer::POAManager_var manager = rootPOA -> the_POAManager();

CosNaming::NamingContext_var cxt;
CORBA::Object_var	nS = orb->resolve_initial_references("NameService");
cxt = CosNaming::NamingContext::_narrow(nS);
</pre>

<h3> OnlineViewer </h3>
<p>
OnlineViewerの取得を行います。
</p>
<pre>
OnlineViewer_var olv = getOnlineViewer(argc, argv);
</pre>
<p>
さらに、OnlineViewerに対してもモデルを読み込ませ、初期化します。
</p>
<pre>
olv->load(floor->name(), Model[0].c_str());
olv->load(body->name(), Model[1].c_str());
olv->clearLog();
</pre>



<h3> DynamicsSimulator</h3>
<p>
サーバ群を取得するために以下のような関数を用意します。
</p>
<pre>
template &lt;typename X, typename X_ptr&gt;
X_ptr checkCorbaServer(std::string n, CosNaming::NamingContext_var &cxt)
{
  CosNaming::Name ncName;
  ncName.length(1);
  ncName[0].id = CORBA::string_dup(n.c_str());
  ncName[0].kind = CORBA::string_dup("");
  X_ptr srv = NULL;
  try {
    srv = X::_narrow(cxt->resolve(ncName));
  } catch(const CosNaming::NamingContext::NotFound &exc) {
    std::cerr << n << " not found: ";
    switch(exc.why) {
    case CosNaming::NamingContext::missing_node:
      std::cerr << "Missing Node" << std::endl;
    case CosNaming::NamingContext::not_context:
      std::cerr << "Not Context" << std::endl;
      break;
    case CosNaming::NamingContext::not_object:
      std::cerr << "Not Object" << std::endl;
      break;
    }
    return (X_ptr)NULL;
  } catch(CosNaming::NamingContext::CannotProceed &exc) {
    std::cerr << "Resolve " << n << " CannotProceed" << std::endl;
  } catch(CosNaming::NamingContext::AlreadyBound &exc) {
    std::cerr << "Resolve " << n << " InvalidName" << std::endl;
  }
  return srv;
}
</pre>
<p>
これはNamingServiceから指定した型を取得した後、種々の例外処理を行うものです。この関数を利用してDynamicsSimulatorFactoryの取得を行います。
</p>
<pre>
DynamicsSimulatorFactory_var dynamicsSimulatorFactory;
dynamicsSimulatorFactory =
  checkCorbaServer &lt;DynamicsSimulatorFactory, DynamicsSimulatorFactory_var&gt; ("DynamicsSimulatorFactory", cxt);

if (CORBA::is_nil(dynamicsSimulatorFactory)) {
  std::cerr << "DynamicsSimulatorFactory not found" << std::endl;
}

DynamicsSimulator_var dynamicsSimulator = dynamicsSimulatorFactory->create();
</pre>
<p>
ここでは、DynamicsSimulatorFactoryから、createメソッドを使用しDynamicsSimulatorを作成しています。<br/>
次に、DynamicsSimulatorの初期化を行います。
</p>
<pre>
dynamicsSimulator->registerCharacter(floor->name(), floor);			    
dynamicsSimulator->registerCharacter(body->name(), body);
dynamicsSimulator->init(timeStep, DynamicsSimulator::RUNGE_KUTTA, DynamicsSimulator::ENABLE_SENSOR);
</pre>
<p>
最初に、DynamicsSimulatorに床とロボットのモデルを登録します。<br/>
次に、initメソッドでシミュレーション1ステップごとの時間、差分法、センサーの有効/無効を設定します。<br/>
差分法にはオイラー法を用いるDynamicsSimulator::EULERとルンゲクッタ法を用いるDynamicsSimulator::RUNGE_KUTTAが設定できます。<br/>
センサーは有効にするDynamicsSimulator::ENABLE_SENSORと無効にするDynamicsSimulator::DISABLE_SENSORがあります。<br/>
</p>
<p>
次に、重力ベクトルを設定します。
</p>
<pre>
DblSequence3 g;
g.length(3);
g[0] = 0.0;
g[1] = 0.0;
g[2] = world_gravity;
dynamicsSimulator->setGVector(g);
</pre>
<p>
次に、ロボットの初期位置と姿勢を設定します。
</p>
<pre>
Vector3  waist_p;
Matrix33 waist_R;
waist_p = 0, 0, 0.7135;
waist_R = tvmet::identity&lt;Matrix33&gt;();
DblSequence trans;
trans.length(12);
for(int i=0; i<3; i++) trans[i]   = waist_p(i);
for(int i=0; i<3; i++){
	for(int j=0; j<3; j++) trans[3+3*i+j] = waist_R(i,j);
}
dynamicsSimulator->setCharacterLinkData( body->name(), "WAIST", DynamicsSimulator::ABS_TRANSFORM, trans );
</pre>
<p>
関節の初期角度も設定します。
</p>
<pre>
DblSequence angle;
angle.length(29);
angle[0] = 0.0;         angle[1] = -0.0360373;  angle[2] = 0.0;         angle[3] = 0.0785047;
angle[4] = -0.0424675;  angle[5] = 0.0;         angle[6] = 0.174533;    angle[7] = -0.00349066;
angle[8] = 0.0;         angle[9] = -1.5708;     angle[10] = 0.0;        angle[11] = 0.0;
angle[12] = 0.0;        angle[13] = 0.0;        angle[14] = -0.0360373; angle[15] = 0.0;
angle[16] = 0.0785047;  angle[17] = -0.0424675; angle[18] = 0.0;        angle[19] = 0.174533;
angle[20] = -0.00349066;angle[21] = 0.0;        angle[22] = -1.5708;    angle[23] = 0.0;
angle[24] = 0.0;        angle[25] = 0.0;        angle[26] = 0.0;        angle[27] = 0.0;
angle[28] = 0.0;
dynamicsSimulator->setCharacterAllLinkData( body->name(), DynamicsSimulator::JOINT_VALUE, angle );
</pre>
<p>
設定が終わったら順運動学計算を１回行い、姿勢に反映させます。
</p>
<pre>
dynamicsSimulator->calcWorldForwardKinematics();
</pre>
<p>
次に衝突検出ペアの登録を行います。ここで登録されたペア同士の衝突検出が行われることになります。ロボットと床の間にペアを設定しています。
</p>
<pre>
DblSequence6 K, C;    
K.length(0);
C.length(0);
dynamicsSimulator->registerCollisionCheckPair(floor->name(),"", body->name() ,"",
		                                            statFric,slipFric,K,C,culling_thresh);
</pre>
<p>
最後に初期化メソッドを呼びます。
</p>
<pre>
dynamicsSimulator->initSimulation();
</pre>

<h3> Controller </h3>
<p>
Controllerを取得する際はそれぞれのController名で行います。
</p>
<pre>
Controller_var controller;
controller = checkCorbaServer &lt;Controller, Controller_var&gt; ("SamplePDController", cxt);

if (CORBA::is_nil(controller)) {
   std::cerr << "Controller not found" << std::endl;
}
</pre>
<p>
この場合はSamplePDControllerという名前のControllerを取得しています。</br>
Controllerの設定を行います。
</p>
<pre>
controller->setModelName(body->name());
controller->setDynamicsSimulator(dynamicsSimulator);
controller->initialize();
controller->setTimeStep(controlTimeStep);
</pre>
<p>
最後にスタートさせます。
</p>
<pre>
controller->start();
</pre>

<h3> シミュレーションループ </h3>
<p>
実際のシミュレーション実行時にまわされるループです。以下の構成を持ちます。
</p>

<ol>
<li>Controller::inputの呼び出し（DynamicsSimulatorからControllerへロボットデータを入力）</li>
<li>Controller::controlの呼び出し（Controllerの出力値の計算）</li>
<li>dynamicsSimulator::stepSimulationの呼び出し　(シミュレーション1ステップ実行）</li>
<li>dynamicsSimulator::getWorldStateの呼び出し　(シミュレーション結果の読み出し)</li>
<li>OnlineViewer::updateの呼び出し　（OnlineViewerの更新)</li>
<li>Controller::outputの呼び出し (ControllerからCynamicdSimulatorへ制御値を出力）</li>
</ol>
<p>
具体的な形は以下のようになります。
</p>
<pre>
bool control=false;
if(controlTime <= time){
    control=true;
    j++;
}

if(control)
    controller->input();

i++;
time = timeStep * i;
controlTime = controlTimeStep * j;

if(control)
    controller->control();
               
// ================== simulate one step ==============
dynamicsSimulator->stepSimulation();					    
              
// ================== viewer update ====================
try {
    dynamicsSimulator -> getWorldState( state );
    olv->update( state );
} catch (CORBA::SystemException& ex) {
    return 1;
}

// ===================== get robot status ===================
DblSequence_var waist_pR;  // position and attitude
DblSequence_var waist_vw;  // linear and angular velocities
dynamicsSimulator->getCharacterLinkData(body->name(), "WAIST", DynamicsSimulator::ABS_TRANSFORM, waist_pR);
dynamicsSimulator->getCharacterLinkData(body->name(), "WAIST", DynamicsSimulator::ABS_VELOCITY,  waist_vw);

// ================== log data save =====================
log_file << time << " ";
log_file << waist_vw[2] << " ";
log_file << endl;

if(control)
    controller->output();

if( time > EndTime ) break;
</pre>

<h2> 実行方法 </h2>
<ol>
<li>GrxUIを起動。</li>
<li>OpenHRP/sample/controller/SamplePD/SamplePD.sh (.bat) をコマンドラインから実行。</li>
<li>OpenHRP/sample/example/scheduler/scheduler.sh (.bat) をコマンドラインから実行。</li>
</ol>
<p>
Windowsでコマンドラインから実行する時は、(OpenHRPのインストールディレクトリ)/bin にパスを通してください。
</p>
    






</div>
  </td>
 </tr>
</table>
</div>



<hr class="full_hr" />



<div id="footer">
<table id="footertable" border="0" cellspacing="0" cellpadding="0">
<tr>
 <td id="footerctable"><div id="sigunature">
  Administrator: OpenHRP Team, Humanoid Resarch Group, Intelligent Systems Research Institute, AIST
 </div></td>
</tr>
</table>
</div>

</body>
</html>
